<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>فرم تخصصی بازدید آموزشی - ناحیه سه شیراز</title>
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalali-moment@3.3.10/dist/jalali-moment.browser.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://v1.fontapi.ir/css/Vazir:300,400,500" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #ef4444, #ec4899);
      min-height: 100vh;
      font-family: 'Vazir', sans-serif;
      font-size: 0.85rem;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #991b1b, #9d174d);
      color: #e5e7eb;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      padding: 1.5rem;
      margin-bottom: 2rem;
      transition: transform 0.3s, background-color 0.3s;
    }
    .card.dark-mode {
      background: #374151;
      color: #e5e7eb;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .gradient-btn {
      background: linear-gradient(90deg, #ef4444, #ec4899);
      color: white;
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 1.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }
    .gradient-btn:hover {
      background: linear-gradient(90deg, #b91c1c, #be185d);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }
    .gradient-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }
    .gradient-btn:hover::before {
      width: 200px;
      height: 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      text-align: right;
      font-size: 0.8rem;
    }
    th {
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 600;
    }
    .dark-mode th {
      background: #991b1b;
      color: #e5e7eb;
    }
    textarea, input[type="number"], input[type="text"], input[type="date"], select {
      width: 100%;
      font-size: 0.8rem;
      padding: 0.5rem;
      border: 1px solid #ef4444;
      border-radius: 0.5rem;
      transition: border-color 0.3s;
      background: white;
      color: #1f2937;
    }
    .dark-mode textarea, .dark-mode input, .dark-mode select {
      background: #4b5563;
      color: #e5e7eb;
      border-color: #6b7280;
    }
    textarea:focus, input:focus, select:focus {
      border-color: #b91c1c;
      outline: none;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }
    textarea {
      resize: vertical;
    }
    .average {
      font-weight: bold;
      color: #b91c1c;
    }
    .dark-mode .average {
      color: #f9a8d4;
    }
    .footer {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
      margin-top: 2rem;
      opacity: 0.9;
    }
    .dark-mode .footer {
      color: #d1d5db;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #1f2937;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #chartContainer {
      max-width: 600px;
      margin: 2rem auto;
    }
    .header {
      text-align: center;
      color: #fff;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .signature-pad {
      border: 1px solid #ef4444;
      border-radius: 0.5rem;
      width: 100%;
      height: 150px;
      background-color: white;
    }
    .dark-mode .signature-pad {
      background-color: #4b5563;
    }
    @media (max-width: 640px) {
      .container {
        padding: 0.75rem;
      }
      .card {
        padding: 1rem;
        border-radius: 0.75rem;
      }
      th, td {
        padding: 0.3rem;
        font-size: 0.7rem;
      }
      input, textarea, select {
        font-size: 0.75rem;
        padding: 0.4rem;
      }
      .gradient-btn {
        padding: 0.6rem 1.2rem;
        font-size: 0.85rem;
      }
      .button-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 0.75rem;
        box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
      }
      .dark-mode .button-container {
        background: #1f2937;
      }
      .grid-cols-3 {
        grid-template-columns: 1fr;
      }
      .search-container {
        flex-direction: column;
      }
      .header {
        font-size: 1rem;
      }
      .signature-pad {
        height: 100px;
      }
    }
    @media print {
      body {
        font-size: 0.7rem;
        margin: 0.5cm;
        padding: 0;
      }
      .card, .button-container, #dashboard, .search-container, #toggleDarkMode {
        display: none;
      }
      table {
        page-break-inside: auto;
        font-size: 0.6rem;
      }
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      th, td {
        padding: 0.2rem;
        font-size: 0.6rem;
      }
      textarea {
        white-space: pre-wrap;
        overflow-wrap: break-word;
      }
      .signature-pad {
        border: 1px solid black;
        height: 30px;
      }
      h1, h2, h3 {
        font-size: 1rem;
        page-break-after: avoid;
      }
      p {
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    📚 بسم الله الرحمن الرحیم 📚
  </div>

  <div class="container">
    <div class="card">
      <h1 class="text-2xl font-bold text-center text-red-900 mb-4 dark-mode:text-red-300">فرم تخصصی بازدید و نظارت آموزشی از کلاس درس - مقطع ابتدایی</h1>
      <p class="text-center text-gray-600 text-sm mb-6 dark-mode:text-gray-400">اداره آموزش و پرورش ناحیه سه شیراز</p>

      <!-- Dark Mode Toggle -->
      <div class="flex justify-end mb-4">
        <button id="toggleDarkMode" class="gradient-btn">تغییر به حالت تاریک</button>
      </div>

      <!-- Advanced Search -->
      <div class="search-container">
        <div class="w-full">
          <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">جستجوی فرم ذخیره‌شده</label>
          <input id="search_form" type="text" placeholder="جستجو بر اساس نام، کد پرسنلی یا تاریخ" class="mt-1">
        </div>
        <div class="w-full">
          <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">انتخاب فرم ذخیره‌شده</label>
          <select id="load_form_select" class="mt-1 block w-full rounded-md border-gray-300">
            <option value="">-- هیچ‌کدام --</option>
          </select>
        </div>
        <button onclick="loadForm()" class="gradient-btn px-4 py-1 mt-2">بارگذاری فرم</button>
      </div>

      <!-- Saved Forms Table -->
      <div class="card overflow-x-auto">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">جدول افراد ثبت شده</h2>
        <table id="saved_forms_table">
          <thead>
            <tr>
              <th>نام آموزگار</th>
              <th>کد پرسنلی</th>
              <th>تاریخ بازدید (شمسی)</th>
              <th>آخرین بروزرسانی</th>
              <th>عملیات</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be populated dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Analytical Dashboard -->
      <div class="card" id="dashboard">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">داشبورد تحلیلی</h2>
        <canvas id="scoreChart"></canvas>
      </div>

      <!-- General Information Form -->
      <div class="card">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">مشخصات عمومی</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="tooltip">
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نام آموزگار</label>
            <input id="teacher" type="text" required>
            <span class="tooltiptext">نام و نام خانوادگی کامل آموزگار</span>
          </div>
          <div class="tooltip">
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">کد پرسنلی (۸ رقم)</label>
            <input id="personnel_code" type="text" maxlength="8" pattern="[0-9]{8}" required>
            <span class="tooltiptext">کد پرسنلی ۸ رقمی را وارد کنید</span>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">شماره همراه آموزگار</label>
            <input id="teacher_phone" type="tel" pattern="[0-9]{11}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">پایه تحصیلی</label>
            <input id="grade" type="text" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نام مدیر</label>
            <input id="principal" type="text" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نام مدرسه</label>
            <input id="school" type="text" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نام بازدیدکننده</label>
            <input id="inspector" type="text" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">جنسیت</label>
            <select id="gender" required>
              <option value="">انتخاب</option>
              <option value="مرد">مرد</option>
              <option value="زن">زن</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">تاریخ بازدید (میلادی)</label>
            <input id="date" type="date" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">شماره همراه مدیر</label>
            <input id="principal_phone" type="tel" pattern="[0-9]{11}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نوع مدرسه</label>
            <select id="school_type" required>
              <option value="">انتخاب</option>
              <option value="دولتی">دولتی</option>
              <option value="غیردولتی">غیردولتی</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نمره پیش‌فرض (۱-۴)</label>
            <input id="default_score" type="number" min="1" max="4" placeholder="نمره پیش‌فرض برای تمام بخش‌ها">
            <button onclick="fillDefaultScores()" class="gradient-btn px-4 py-1 mt-2">اعمال نمره پیش‌فرض</button>
          </div>
        </div>
      </div>

      <!-- Evaluation Sections -->
      <div class="card overflow-x-auto" id="section1">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">محور اول - کیفیت تدریس و مدیریت یاددهی-یادگیری</h2>
        <table>
          <thead>
            <tr>
              <th>ردیف</th>
              <th>شاخص ارزیابی</th>
              <th>توضیح/شواهد</th>
              <th>عالی (۴)</th>
              <th>خوب (۳)</th>
              <th>متوسط (۲)</th>
              <th>ضعیف (۱)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>۱</td>
              <td>تهیه و اجرای طرح درس شایستگی‌محور و روزانه</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_1" value="4" class="score"></td>
              <td><input type="radio" name="score1_1" value="3" class="score"></td>
              <td><input type="radio" name="score1_1" value="2" class="score"></td>
              <td><input type="radio" name="score1_1" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۲</td>
              <td>خلاقیت و تنوع در روش‌های تدریس (فعال، STEAM) به‌منظور یادگیری مؤثر و نقش راهبری معلم</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_2" value="4" class="score"></td>
              <td><input type="radio" name="score1_2" value="3" class="score"></td>
              <td><input type="radio" name="score1_2" value="2" class="score"></td>
              <td><input type="radio" name="score1_2" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳</td>
              <td>رعایت بودجه‌بندی درسی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_3" value="4" class="score"></td>
              <td><input type="radio" name="score1_3" value="3" class="score"></td>
              <td><input type="radio" name="score1_3" value="2" class="score"></td>
              <td><input type="radio" name="score1_3" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۴</td>
              <td>استفاده از رسانه، فناوری، هوش مصنوعی و وسایل آموزشی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_4" value="4" class="score"></td>
              <td><input type="radio" name="score1_4" value="3" class="score"></td>
              <td><input type="radio" name="score1_4" value="2" class="score"></td>
              <td><input type="radio" name="score1_4" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۵</td>
              <td>توجه به مراحل تدریس و نقش راهبردی معلم</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_5" value="4" class="score"></td>
              <td><input type="radio" name="score1_5" value="3" class="score"></td>
              <td><input type="radio" name="score1_5" value="2" class="score"></td>
              <td><input type="radio" name="score1_5" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۶</td>
              <td>مشارکت فعال دانش‌آموزان و تقویت پرسشگری</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_6" value="4" class="score"></td>
              <td><input type="radio" name="score1_6" value="3" class="score"></td>
              <td><input type="radio" name="score1_6" value="2" class="score"></td>
              <td><input type="radio" name="score1_6" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۷</td>
              <td>مدیریت کلاس و نظم‌بخشی به فرآیند یادگیری</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_7" value="4" class="score"></td>
              <td><input type="radio" name="score1_7" value="3" class="score"></td>
              <td><input type="radio" name="score1_7" value="2" class="score"></td>
              <td><input type="radio" name="score1_7" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۸</td>
              <td>ایجاد فضای کلاسی شاد، پویا و متنوع (چیدمان کلاس)</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_8" value="4" class="score"></td>
              <td><input type="radio" name="score1_8" value="3" class="score"></td>
              <td><input type="radio" name="score1_8" value="2" class="score"></td>
              <td><input type="radio" name="score1_8" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۹</td>
              <td>تلفیق مفاهیم تربیتی و درسی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score1_9" value="4" class="score"></td>
              <td><input type="radio" name="score1_9" value="3" class="score"></td>
              <td><input type="radio" name="score1_9" value="2" class="score"></td>
              <td><input type="radio" name="score1_9" value="1" class="score"></td>
            </tr>
          </tbody>
        </table>
        <p class="average mt-2">میانگین محور ۱: <span id="avg1">0</span></p>
      </div>

      <div class="card overflow-x-auto" id="section2">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">محور دوم - ارزشیابی و پایش یادگیری</h2>
        <table>
          <thead>
            <tr>
              <th>ردیف</th>
              <th>شاخص ارزیابی</th>
              <th>توضیح/شواهد</th>
              <th>عالی (۴)</th>
              <th>خوب (۳)</th>
              <th>متوسط (۲)</th>
              <th>ضعیف (۱)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>۱</td>
              <td>کاربرد انواع ارزشیابی (آغازین، تکوینی، پایانی)</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score2_1" value="4" class="score"></td>
              <td><input type="radio" name="score2_1" value="3" class="score"></td>
              <td><input type="radio" name="score2_1" value="2" class="score"></td>
              <td><input type="radio" name="score2_1" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۲</td>
              <td>استفاده از ابزارهای ارزشیابی (عملکردی، کاغذی، دیجیتال و ...)</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score2_2" value="4" class="score"></td>
              <td><input type="radio" name="score2_2" value="3" class="score"></td>
              <td><input type="radio" name="score2_2" value="2" class="score"></td>
              <td><input type="radio" name="score2_2" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳</td>
              <td>تحلیل نتایج آزمون و ارائه بازخورد مناسب</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score2_3" value="4" class="score"></td>
              <td><input type="radio" name="score2_3" value="3" class="score"></td>
              <td><input type="radio" name="score2_3" value="2" class="score"></td>
              <td><input type="radio" name="score2_3" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۴</td>
              <td>توجه به تکالیف هدفمند و متنوع (خلاقیتی، مهارتی، فردی / گروهی)</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score2_4" value="4" class="score"></td>
              <td><input type="radio" name="score2_4" value="3" class="score"></td>
              <td><input type="radio" name="score2_4" value="2" class="score"></td>
              <td><input type="radio" name="score2_4" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۵</td>
              <td>تنوع ابزار در پوشه کار دانش‌آموز</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score2_5" value="4" class="score"></td>
              <td><input type="radio" name="score2_5" value="3" class="score"></td>
              <td><input type="radio" name="score2_5" value="2" class="score"></td>
              <td><input type="radio" name="score2_5" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۶</td>
              <td>ثبت بازخورد و نتایج یادگیری در دفتر مدیریت کلاسی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score2_6" value="4" class="score"></td>
              <td><input type="radio" name="score2_6" value="3" class="score"></td>
              <td><input type="radio" name="score2_6" value="2" class="score"></td>
              <td><input type="radio" name="score2_6" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۷</td>
              <td>تنظیم و ارائه کارنامه ماهانه</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score2_7" value="4" class="score"></td>
              <td><input type="radio" name="score2_7" value="3" class="score"></td>
              <td><input type="radio" name="score2_7" value="2" class="score"></td>
              <td><input type="radio" name="score2_7" value="1" class="score"></td>
            </tr>
          </tbody>
        </table>
        <p class="average mt-2">میانگین محور ۲: <span id="avg2">0</span></p>
      </div>

      <div class="card overflow-x-auto" id="section3">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">محور سوم - پایش یادگیری دانش‌آموزان</h2>
        <table>
          <thead>
            <tr>
              <th>ردیف</th>
              <th>شاخص ارزیابی</th>
              <th>توضیح/شواهد</th>
              <th>عالی (۴)</th>
              <th>خوب (۳)</th>
              <th>متوسط (۲)</th>
              <th>ضعیف (۱)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>۱</td>
              <td>توجه فراگیران در حل مسئله و پاسخ‌گویی بر اساس روش‌های نوین</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_1" value="4" class="score"></td>
              <td><input type="radio" name="score3_1" value="3" class="score"></td>
              <td><input type="radio" name="score3_1" value="2" class="score"></td>
              <td><input type="radio" name="score3_1" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۲</td>
              <td>توجه به زیبانویسی دانش‌آموزان</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_2" value="4" class="score"></td>
              <td><input type="radio" name="score3_2" value="3" class="score"></td>
              <td><input type="radio" name="score3_2" value="2" class="score"></td>
              <td><input type="radio" name="score3_2" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳</td>
              <td>کیفیت دروس ارائه‌شده با محوریت یادگیری دروس زیر</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_3" value="4" class="score"></td>
              <td><input type="radio" name="score3_3" value="3" class="score"></td>
              <td><input type="radio" name="score3_3" value="2" class="score"></td>
              <td><input type="radio" name="score3_3" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳-۱</td>
              <td>قرآن و هدیه‌های آسمانی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_3_1" value="4" class="score"></td>
              <td><input type="radio" name="score3_3_1" value="3" class="score"></td>
              <td><input type="radio" name="score3_3_1" value="2" class="score"></td>
              <td><input type="radio" name="score3_3_1" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳-۲</td>
              <td>تعلیمات اجتماعی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_3_2" value="4" class="score"></td>
              <td><input type="radio" name="score3_3_2" value="3" class="score"></td>
              <td><input type="radio" name="score3_3_2" value="2" class="score"></td>
              <td><input type="radio" name="score3_3_2" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳-۳</td>
              <td>ریاضی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_3_3" value="4" class="score"></td>
              <td><input type="radio" name="score3_3_3" value="3" class="score"></td>
              <td><input type="radio" name="score3_3_3" value="2" class="score"></td>
              <td><input type="radio" name="score3_3_3" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳-۴</td>
              <td>فارسی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_3_4" value="4" class="score"></td>
              <td><input type="radio" name="score3_3_4" value="3" class="score"></td>
              <td><input type="radio" name="score3_3_4" value="2" class="score"></td>
              <td><input type="radio" name="score3_3_4" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳-۵</td>
              <td>علوم تجربی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_3_5" value="4" class="score"></td>
              <td><input type="radio" name="score3_3_5" value="3" class="score"></td>
              <td><input type="radio" name="score3_3_5" value="2" class="score"></td>
              <td><input type="radio" name="score3_3_5" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳-۶</td>
              <td>هنر، کار و فناوری، تفکر و پژوهش</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score3_3_6" value="4" class="score"></td>
              <td><input type="radio" name="score3_3_6" value="3" class="score"></td>
              <td><input type="radio" name="score3_3_6" value="2" class="score"></td>
              <td><input type="radio" name="score3_3_6" value="1" class="score"></td>
            </tr>
          </tbody>
        </table>
        <p class="average mt-2">میانگین محور ۳: <span id="avg3">0</span></p>
      </div>

      <div class="card overflow-x-auto" id="section4">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">محور چهارم - نظم، برنامه‌ریزی و مسئولیت‌پذیری</h2>
        <table>
          <thead>
            <tr>
              <th>ردیف</th>
              <th>شاخص ارزیابی</th>
              <th>توضیح/شواهد</th>
              <th>عالی (۴)</th>
              <th>خوب (۳)</th>
              <th>متوسط (۲)</th>
              <th>ضعیف (۱)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>۱</td>
              <td>رعایت نظم در ورود و خروج و زمان‌بندی فعالیت‌ها</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score4_1" value="4" class="score"></td>
              <td><input type="radio" name="score4_1" value="3" class="score"></td>
              <td><input type="radio" name="score4_1" value="2" class="score"></td>
              <td><input type="radio" name="score4_1" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۲</td>
              <td>برنامه‌ریزی هفتگی / ماهانه و انعطاف‌پذیری در اجرا با توجه به برنامه درسی ملی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score4_2" value="4" class="score"></td>
              <td><input type="radio" name="score4_2" value="3" class="score"></td>
              <td><input type="radio" name="score4_2" value="2" class="score"></td>
              <td><input type="radio" name="score4_2" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳</td>
              <td>توجه به نکات آموزشی در شورای معلمان</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score4_3" value="4" class="score"></td>
              <td><input type="radio" name="score4_3" value="3" class="score"></td>
              <td><input type="radio" name="score4_3" value="2" class="score"></td>
              <td><input type="radio" name="score4_3" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۴</td>
              <td>تحلیل نتایج آزمون و ارائه بازخورد مناسب</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score4_4" value="4" class="score"></td>
              <td><input type="radio" name="score4_4" value="3" class="score"></td>
              <td><input type="radio" name="score4_4" value="2" class="score"></td>
              <td><input type="radio" name="score4_4" value="1" class="score"></td>
            </tr>
          </tbody>
        </table>
        <p class="average mt-2">میانگین محور ۴: <span id="avg4">0</span></p>
      </div>

      <div class="card overflow-x-auto" id="section5">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">محور پنجم - تعامل و ارتباط مؤثر</h2>
        <table>
          <thead>
            <tr>
              <th>ردیف</th>
              <th>شاخص ارزیابی</th>
              <th>توضیح/شواهد</th>
              <th>عالی (۴)</th>
              <th>خوب (۳)</th>
              <th>متوسط (۲)</th>
              <th>ضعیف (۱)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>۱</td>
              <td>ارتباط سازنده با دانش‌آموزان و ایجاد فضای بدون استرس و اضطراب</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score5_1" value="4" class="score"></td>
              <td><input type="radio" name="score5_1" value="3" class="score"></td>
              <td><input type="radio" name="score5_1" value="2" class="score"></td>
              <td><input type="radio" name="score5_1" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۲</td>
              <td>تعامل مؤثر با اولیا و جلب مشارکت آنان</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score5_2" value="4" class="score"></td>
              <td><input type="radio" name="score5_2" value="3" class="score"></td>
              <td><input type="radio" name="score5_2" value="2" class="score"></td>
              <td><input type="radio" name="score5_2" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳</td>
              <td>همکاری و مشارکت در فضای مدرسه</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score5_3" value="4" class="score"></td>
              <td><input type="radio" name="score5_3" value="3" class="score"></td>
              <td><input type="radio" name="score5_3" value="2" class="score"></td>
              <td><input type="radio" name="score5_3" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۴</td>
              <td>ایجاد روحیه همدلی، گذشت و احترام متقابل بین همکاران، دانش‌آموزان و اولیا</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score5_4" value="4" class="score"></td>
              <td><input type="radio" name="score5_4" value="3" class="score"></td>
              <td><input type="radio" name="score5_4" value="2" class="score"></td>
              <td><input type="radio" name="score5_4" value="1" class="score"></td>
            </tr>
          </tbody>
        </table>
        <p class="average mt-2">میانگین محور ۵: <span id="avg5">0</span></p>
      </div>

      <div class="card overflow-x-auto" id="section6">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">محور ششم - توسعه حرفه‌ای و اخلاقی</h2>
        <table>
          <thead>
            <tr>
              <th>ردیف</th>
              <th>شاخص ارزیابی</th>
              <th>توضیح/شواهد</th>
              <th>عالی (۴)</th>
              <th>خوب (۳)</th>
              <th>متوسط (۲)</th>
              <th>ضعیف (۱)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>۱</td>
              <td>آموزش مهارت های اجتماعی )کار گروهی، حل مسئله(</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score6_1" value="4" class="score"></td>
              <td><input type="radio" name="score6_1" value="3" class="score"></td>
              <td><input type="radio" name="score6_1" value="2" class="score"></td>
              <td><input type="radio" name="score6_1" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۲</td>
              <td>ترویج ارزش‌های اخلاقی و دینی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score6_2" value="4" class="score"></td>
              <td><input type="radio" name="score6_2" value="3" class="score"></td>
              <td><input type="radio" name="score6_2" value="2" class="score"></td>
              <td><input type="radio" name="score6_2" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۳</td>
              <td>رعایت اخلاق حرفه‌ای و حریم خصوصی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score6_3" value="4" class="score"></td>
              <td><input type="radio" name="score6_3" value="3" class="score"></td>
              <td><input type="radio" name="score6_3" value="2" class="score"></td>
              <td><input type="radio" name="score6_3" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۴</td>
              <td>برخورد منطقی و عادلانه با رفتارهای چالشی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score6_4" value="4" class="score"></td>
              <td><input type="radio" name="score6_4" value="3" class="score"></td>
              <td><input type="radio" name="score6_4" value="2" class="score"></td>
              <td><input type="radio" name="score6_4" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۵</td>
              <td>مشارکت در تصمیم‌سازی و ارائه پیشنهاد در امور آموزشی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score6_5" value="4" class="score"></td>
              <td><input type="radio" name="score6_5" value="3" class="score"></td>
              <td><input type="radio" name="score6_5" value="2" class="score"></td>
              <td><input type="radio" name="score6_5" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۶</td>
              <td>توجه به مناسبت‌های ملی و مذهبی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score6_6" value="4" class="score"></td>
              <td><input type="radio" name="score6_6" value="3" class="score"></td>
              <td><input type="radio" name="score6_6" value="2" class="score"></td>
              <td><input type="radio" name="score6_6" value="1" class="score"></td>
            </tr>
            <tr>
              <td>۷</td>
              <td>خلاقیت در فعالیت‌های آموزشی و پرورشی</td>
              <td><textarea rows="2"></textarea></td>
              <td><input type="radio" name="score6_7" value="4" class="score"></td>
              <td><input type="radio" name="score6_7" value="3" class="score"></td>
              <td><input type="radio" name="score6_7" value="2" class="score"></td>
              <td><input type="radio" name="score6_7" value="1" class="score"></td>
            </tr>
          </tbody>
        </table>
        <p class="average mt-2">میانگین محور ۶: <span id="avg6">0</span></p>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">بخش تحلیل تخصصی</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نکات قوت</label>
            <textarea id="strengths" rows="4"></textarea>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نکات قابل بهبود</label>
            <textarea id="improvements" rows="4"></textarea>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">پیشنهادات تخصصی</label>
            <textarea id="suggestions" rows="4"></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">محورهای تحلیل بازدیدکننده</h2>
        <table>
          <thead>
            <tr>
              <th>محور</th>
              <th>توضیحات</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>مدیریت کلاس</td>
              <td><textarea rows="2" class="visitor-analysis"></textarea></td>
            </tr>
            <tr>
              <td>روش تدریس</td>
              <td><textarea rows="2" class="visitor-analysis"></textarea></td>
            </tr>
            <tr>
              <td>استفاده از فناوری</td>
              <td><textarea rows="2" class="visitor-analysis"></textarea></td>
            </tr>
            <tr>
              <td>تعامل و ارتباط با دانش‌آموزان</td>
              <td><textarea rows="2" class="visitor-analysis"></textarea></td>
            </tr>
            <tr>
              <td>ارزشیابی و بازخورد</td>
              <td><textarea rows="2" class="visitor-analysis"></textarea></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">خودارزیابی معلم</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">نقاط قوت تدریس امروز</label>
            <textarea id="teacher_strengths" rows="2"></textarea>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">چالش‌های مشاهده‌شده</label>
            <textarea id="teacher_challenges" rows="2"></textarea>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">پیشنهاد برای بهبود</label>
            <textarea id="teacher_suggestions" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">جمع‌بندی</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">سابقه تدریس در این پایه</label>
            <input id="teaching_experience" type="text" required>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">جمع‌بندی بازدیدکننده</label>
          <textarea id="summary" rows="4"></textarea>
        </div>
        <div class="mt-3">
          <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">ارزیابی نهایی</label>
          <select id="final_evaluation">
            <option value="عالی">عالی</option>
            <option value="خوب">خوب</option>
            <option value="متوسط">متوسط</option>
            <option value="ضعیف">ضعیف</option>
          </select>
        </div>
        <p class="average mt-4">معدل کل: <span id="overall_avg">0</span></p>
        <div class="mt-4">
          <h3 class="text-md font-semibold text-red-800 dark-mode:text-red-300">تحلیل هوشمند</h3>
          <table class="mt-2">
            <thead>
              <tr>
                <th>محور تحلیل</th>
                <th>توضیحات</th>
              </tr>
            </thead>
            <tbody id="smart_analysis">
              <tr><td>تحلیل توانایی</td><td>-</td></tr>
              <tr><td>تحلیل هوش</td><td>-</td></tr>
              <tr><td>تحلیل روانشناسی</td><td>-</td></tr>
              <tr><td>تحلیل عملکرد کلی</td><td>-</td></tr>
              <tr><td>تحلیل نقاط قوت و ضعف</td><td>-</td></tr>
              <tr><td>پیشنهادات</td><td>-</td></tr>
              <tr><td>وضعیت پاداش/تشویق</td><td>-</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Signature Pads -->
      <div class="card">
        <h2 class="text-lg font-semibold text-red-800 mb-3 dark-mode:text-red-300">امضاها</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">امضای بازدیدکننده</label>
            <canvas id="inspector_signature_pad" class="signature-pad"></canvas>
            <button onclick="clearSignature('inspector_signature_pad')" class="gradient-btn px-4 py-1 mt-2">پاک کردن</button>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 dark-mode:text-gray-300">امضای آموزگار</label>
            <canvas id="teacher_signature_pad" class="signature-pad"></canvas>
            <button onclick="clearSignature('teacher_signature_pad')" class="gradient-btn px-4 py-1 mt-2">پاک کردن</button>
          </div>
        </div>
      </div>

      <div class="button-container flex justify-center space-x-2 mt-6 md:space-x-4">
        <button onclick="startTour()" class="gradient-btn">راهنمای تعاملی</button>
        <button onclick="saveForm()" class="gradient-btn">ذخیره فرم</button>
        <button onclick="previewForm()" class="gradient-btn">پیش‌نمایش گزارش</button>
        <button onclick="printForm()" class="gradient-btn">چاپ گزارش (PDF)</button>
        <button onclick="exportToJSON()" class="gradient-btn">صادرات به JSON</button>
        <button onclick="importFromJSON()" class="gradient-btn">ورود از JSON</button>
        <button onclick="exportToCSV()" class="gradient-btn">صادرات به CSV</button>
        <button onclick="importFromExcel()" class="gradient-btn">ورود از اکسل</button>
        <button onclick="clearForm()" class="gradient-btn">پاک کردن فرم</button>
        <button onclick="clearAllData()" class="gradient-btn">پاک کردن تمام اطلاعات</button>
      </div>
    </div>
  </div>

  <div class="footer">
    سازنده: حسین هادی پور 🔨
  </div>

  <input type="file" id="json_import_file" style="display: none;" accept=".json">
  <input type="file" id="excel_import_file" style="display: none;" accept=".xlsx">

  <script>
    // Initialize the form on page load
    window.onload = function() {
      Swal.fire({
        icon: 'info',
        title: 'خوش‌آمدگویی',
        html: 'لطفاً فرم را با دقت پر کنید. برای ذخیره داده‌ها از دکمه "ذخیره فرم" استفاده کنید.<br>برای راهنمایی، از دکمه "راهنمای تعاملی" استفاده کنید.',
        confirmButtonText: 'باشه'
      });

      // Convert Gregorian date to Persian
      document.getElementById('date').addEventListener('change', function() {
        const date = this.value;
        document.getElementById('persian_date').value = date 
          ? moment(date).locale('fa').format('YYYY/MM/DD') 
          : '';
        autoSaveForm();
      });

      // Load saved forms
      loadFormList();
      loadSavedFormsTable();

      // Advanced search
      document.getElementById('search_form').addEventListener('input', filterForms);

      // Validate personnel code
      document.getElementById('personnel_code').addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length > 8) {
          this.value = this.value.slice(0, 8);
          Swal.fire({
            icon: 'warning',
            title: 'هشدار',
            text: 'کد پرسنلی باید ۸ رقم باشد.',
          });
        }
        autoSaveForm();
      });

      // Validate phone numbers
      ['teacher_phone', 'principal_phone'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9]/g, '');
          if (this.value.length > 11) {
            this.value = this.value.slice(0, 11);
            Swal.fire({
              icon: 'warning',
              title: 'هشدار',
              text: 'شماره همراه باید ۱۱ رقم باشد.',
            });
          }
          autoSaveForm();
        });
      });

      // Validate scores
      document.querySelectorAll('.score').forEach(input => {
        input.addEventListener('change', function() {
          calculateAverages();
          generateSmartAnalysis(document.getElementById('overall_avg').textContent);
          autoSaveForm();
        });
      });

      // Validate required fields
      document.querySelectorAll('input[required], select[required]').forEach(input => {
        input.addEventListener('blur', function() {
          if (!this.value) {
            Swal.fire({
              icon: 'warning',
              title: 'هشدار',
              text: `فیلد ${this.previousElementSibling.textContent} اجباری است.`,
            });
          }
          autoSaveForm();
        });
      });

      // Auto-save on change for all inputs
      document.querySelectorAll('input, textarea, select').forEach(element => {
        element.addEventListener('input', autoSaveForm);
        element.addEventListener('change', autoSaveForm);
      });

      // Initialize signature pads
      initSignaturePad('inspector_signature_pad');
      initSignaturePad('teacher_signature_pad');

      // Initialize chart
      updateChart();
    };

    /**
     * Initialize signature pad
     * @param {string} canvasId - ID of the canvas element
     */
    function initSignaturePad(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#000000';
      let drawing = false;

      function startDrawing(e) {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
      }

      function draw(e) {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }

      function stopDrawing() {
        drawing = false;
        autoSaveForm();
      }

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Touch events for mobile
      canvas.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        startDrawing({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
      });
      canvas.addEventListener('touchmove', (e) => {
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        draw({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
      });
      canvas.addEventListener('touchend', stopDrawing);
    }

    /**
     * Clear signature pad
     * @param {string} canvasId - ID of the canvas element
     */
    function clearSignature(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      autoSaveForm();
    }

    /**
     * Load saved forms into the dropdown
     */
    function loadFormList() {
      const select = document.getElementById('load_form_select');
      select.innerHTML = '<option value="">-- هیچ‌کدام --</option>';
      const personnelCodes = {};

      Object.keys(localStorage)
        .filter(key => key.startsWith('inspection_form_red_pink_'))
        .forEach(key => {
          const formData = JSON.parse(localStorage.getItem(key));
          let displayName = `${formData.teacher} - ${formData.persian_date} - ${formData.personnel_code}`;
          const code = formData.personnel_code;
          personnelCodes[code] = (personnelCodes[code] || 0) + 1;
          if (personnelCodes[code] > 1) {
            displayName += ` (${personnelCodes[code]})`;
          }
          const option = document.createElement('option');
          option.value = key;
          option.textContent = displayName;
          select.appendChild(option);
        });
    }

    /**
     * Load saved forms into the table
     */
    function loadSavedFormsTable() {
      const tbody = document.querySelector('#saved_forms_table tbody');
      tbody.innerHTML = '';
      Object.keys(localStorage)
        .filter(key => key.startsWith('inspection_form_red_pink_'))
        .forEach(key => {
          const formData = JSON.parse(localStorage.getItem(key));
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formData.teacher}</td>
            <td>${formData.personnel_code}</td>
            <td>${formData.persian_date}</td>
            <td>${formData.lastUpdated || '-'}</td>
            <td>
              <button onclick="editForm('${key}')" class="gradient-btn">ویرایش</button>
              <button onclick="deleteForm('${key}')" class="gradient-btn">حذف</button>
            </td>
          `;
          tbody.appendChild(row);
        });
    }

    /**
     * Filter forms based on search input
     */
    function filterForms() {
      const searchValue = document.getElementById('search_form').value.toLowerCase();
      const select = document.getElementById('load_form_select');
      select.innerHTML = '<option value="">-- هیچ‌کدام --</option>';
      const personnelCodes = {};

      Object.keys(localStorage)
        .filter(key => key.startsWith('inspection_form_red_pink_'))
        .forEach(key => {
          const formData = JSON.parse(localStorage.getItem(key));
          const searchString = `${formData.teacher} ${formData.personnel_code} ${formData.persian_date}`.toLowerCase();
          if (searchString.includes(searchValue)) {
            let displayName = `${formData.teacher} - ${formData.persian_date} - ${formData.personnel_code}`;
            const code = formData.personnel_code;
            personnelCodes[code] = (personnelCodes[code] || 0) + 1;
            if (personnelCodes[code] > 1) {
              displayName += ` (${personnelCodes[code]})`;
            }
            const option = document.createElement('option');
            option.value = key;
            option.textContent = displayName;
            select.appendChild(option);
          }
        });
    }

    /**
     * Show interactive tour
     */
    function startTour() {
      Swal.fire({
        title: 'راهنمای تعاملی',
        html: `
          <p>1. <b>مشخصات عمومی:</b> فیلدهای اجباری مانند نام، کد پرسنلی و شماره همراه را پر کنید.</p>
          <p>2. <b>محورهای ارزیابی:</b> برای هر شاخص امتیاز (۱-۴) و توضیحات وارد کنید.</p>
          <p>3. <b>نمره پیش‌فرض:</b> از این گزینه برای پر کردن سریع فرم استفاده کنید.</p>
          <p>4. <b>جستجوی فرم:</b> فرم‌های قبلی را با نام یا کد پرسنلی جستجو کنید.</p>
          <p>5. <b>ذخیره و چاپ:</b> فرم را ذخیره کرده و گزارش PDF تولید کنید.</p>
          <p>6. <b>حالت تاریک:</b> برای راحتی چشم، از دکمه حالت تاریک استفاده کنید.</p>
        `,
        confirmButtonText: 'باشه',
        showCancelButton: true,
        cancelButtonText: 'بستن'
      });
    }

    /**
     * Toggle dark mode
     */
    document.getElementById('toggleDarkMode').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      document.querySelectorAll('.card, .average, .footer, th, td, label').forEach(el => el.classList.toggle('dark-mode'));
      this.textContent = document.body.classList.contains('dark-mode') ? 'تغییر به حالت روشن' : 'تغییر به حالت تاریک';
    });

    let scoreChart;
    /**
     * Update the score chart
     * @param {Object} [formData] - Optional form data to update chart
     */
    function updateChart(formData = null) {
      const ctx = document.getElementById('scoreChart').getContext('2d');
      const averages = formData ? [
        (formData.scores.slice(0, 9).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 9).toFixed(2),
        (formData.scores.slice(9, 16).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 7).toFixed(2),
        (formData.scores.slice(16, 25).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 9).toFixed(2),
        (formData.scores.slice(25, 29).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 4).toFixed(2),
        (formData.scores.slice(29, 33).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 4).toFixed(2),
        (formData.scores.slice(33, 40).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 7).toFixed(2)
      ] : [0, 0, 0, 0, 0, 0];

      if (scoreChart) scoreChart.destroy();
      scoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['محور ۱', 'محور ۲', 'محور ۳', 'محور ۴', 'محور ۵', 'محور ۶'],
          datasets: [{
            label: 'میانگین نمرات',
            data: averages,
            backgroundColor: ['#ef4444', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'],
            borderColor: ['#b91c1c', '#be185d', '#d97706', '#059669', '#2563eb', '#7c3aed'],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 4 }
          }
        }
      });
    }

    /**
     * Load selected form
     */
    function loadForm() {
      const select = document.getElementById('load_form_select');
      const key = select.value;
      if (!key) return;

      const formData = JSON.parse(localStorage.getItem(key));
      if (formData) {
        document.getElementById('teacher').value = formData.teacher || '';
        document.getElementById('personnel_code').value = formData.personnel_code || '';
        document.getElementById('teacher_phone').value = formData.teacher_phone || '';
        document.getElementById('grade').value = formData.grade || '';
        document.getElementById('principal').value = formData.principal || '';
        document.getElementById('school').value = formData.school || '';
        document.getElementById('inspector').value = formData.inspector || '';
        document.getElementById('gender').value = formData.gender || '';
        document.getElementById('date').value = formData.date || '';
        document.getElementById('persian_date').value = formData.persian_date || '';
        document.getElementById('principal_phone').value = formData.principal_phone || '';
        document.getElementById('school_type').value = formData.school_type || '';
        document.getElementById('teaching_experience').value = formData.teaching_experience || '';
        const allScores = document.querySelectorAll('.score');
        if (formData.scores) {
          formData.scores.forEach((score, index) => {
            if (allScores[index]) {
              allScores[index].checked = allScores[index].value === score;
            }
          });
        }
        const allComments = document.querySelectorAll('textarea:not(#strengths, #improvements, #suggestions, #teacher_strengths, #teacher_challenges, #teacher_suggestions, #summary, .visitor-analysis)');
        if (formData.comments) {
          formData.comments.forEach((comment, index) => {
            if (allComments[index]) allComments[index].value = comment;
          });
        }
        const visitorAnalysis = document.querySelectorAll('.visitor-analysis');
        if (formData.visitor_analysis) {
          formData.visitor_analysis.forEach((comment, index) => {
            if (visitorAnalysis[index]) visitorAnalysis[index].value = comment;
          });
        }
        document.getElementById('strengths').value = formData.strengths || '';
        document.getElementById('improvements').value = formData.improvements || '';
        document.getElementById('suggestions').value = formData.suggestions || '';
        document.getElementById('teacher_strengths').value = formData.teacher_strengths || '';
        document.getElementById('teacher_challenges').value = formData.teacher_challenges || '';
        document.getElementById('teacher_suggestions').value = formData.teacher_suggestions || '';
        document.getElementById('summary').value = formData.summary || '';
        document.getElementById('final_evaluation').value = formData.final_evaluation || 'عالی';
        if (formData.inspector_signature) {
          const img = new Image();
          img.src = formData.inspector_signature;
          img.onload = () => {
            document.getElementById('inspector_signature_pad').getContext('2d').drawImage(img, 0, 0);
          };
        }
        if (formData.teacher_signature) {
          const img = new Image();
          img.src = formData.teacher_signature;
          img.onload = () => {
            document.getElementById('teacher_signature_pad').getContext('2d').drawImage(img, 0, 0);
          };
        }
        calculateAverages();
        updateChart(formData);
        Swal.fire({
          icon: 'success',
          title: 'بارگذاری شد',
          text: 'فرم انتخاب‌شده با موفقیت بارگذاری شد.',
        });
      }
    }

    /**
     * Edit form from table
     * @param {string} key - Form key
     */
    function editForm(key) {
      document.getElementById('load_form_select').value = key;
      loadForm();
    }

    /**
     * Delete form from table
     * @param {string} key - Form key
     */
    function deleteForm(key) {
      Swal.fire({
        title: 'آیا مطمئن هستید؟',
        text: 'این فرم برای همیشه حذف خواهد شد.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'بله، حذف کن',
        cancelButtonText: 'خیر'
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.removeItem(key);
          loadFormList();
          loadSavedFormsTable();
          Swal.fire('حذف شد!', 'فرم با موفقیت حذف شد.', 'success');
        }
      });
    }

    /**
     * Apply default scores and comments to all sections
     */
    function fillDefaultScores() {
      const defaultScore = parseInt(document.getElementById('default_score').value);
      if (isNaN(defaultScore) || defaultScore < 1 || defaultScore > 4) {
        Swal.fire({
          icon: 'error',
          title: 'خطا',
          text: 'نمره پیش‌فرض باید بین ۱ تا ۴ باشد.',
        });
        return;
      }

      document.querySelectorAll('.score').forEach(input => {
        input.checked = input.value === defaultScore.toString();
      });

      const defaultSectionComments = {
        4: 'عالی، بدون نقص و با اجرای کامل.',
        3: 'خوب، با عملکرد مناسب اما قابل بهبود.',
        2: 'متوسط، اما نیاز به تلاش بیشتر.',
        1: 'ضعیف، نیازمند بهبود اساسی و توجه ویژه.'
      };
      document.querySelectorAll('textarea:not(#strengths, #improvements, #suggestions, #teacher_strengths, #teacher_challenges, #teacher_suggestions, #summary, .visitor-analysis)').forEach(textarea => {
        textarea.value = defaultSectionComments[defaultScore];
      });

      const defaultAnalysis = {
        4: 'عالی با نقاط قوت برجسته',
        3: 'خوب با عملکرد مناسب اما قابل بهبود',
        2: 'متوسط، نیاز به تلاش بیشتر',
        1: 'ضعیف، نیازمند بهبود اساسی'
      };
      document.getElementById('strengths').value = defaultAnalysis[defaultScore];
      document.getElementById('improvements').value = defaultAnalysis[defaultScore];
      document.getElementById('suggestions').value = defaultAnalysis[defaultScore];
      document.getElementById('teacher_strengths').value = defaultAnalysis[defaultScore];
      document.getElementById('teacher_challenges').value = defaultAnalysis[defaultScore];
      document.getElementById('teacher_suggestions').value = defaultAnalysis[defaultScore];
      document.getElementById('summary').value = defaultAnalysis[defaultScore];
      document.querySelectorAll('.visitor-analysis').forEach(textarea => {
        textarea.value = defaultAnalysis[defaultScore];
      });

      calculateAverages();
      updateChart();
      autoSaveForm();
      Swal.fire({
        icon: 'success',
        title: 'اعمال شد',
        text: `نمره پیش‌فرض ${defaultScore} و توضیحات مربوطه با موفقیت اعمال شدند.`,
      });
    }

    /**
     * Calculate section and overall averages
     */
    function calculateAverages() {
      const scores = Array.from(document.querySelectorAll('.score:checked')).map(input => parseInt(input.value) || 0);
      const sectionRanges = [
        { start: 0, end: 9, avgId: 'avg1' },   // محور ۱: ۹ شاخص
        { start: 9, end: 16, avgId: 'avg2' },  // محور ۲: ۷ شاخص
        { start: 16, end: 25, avgId: 'avg3' }, // محور ۳: ۹ شاخص
        { start: 25, end: 29, avgId: 'avg4' }, // محور ۴: ۴ شاخص
        { start: 29, end: 33, avgId: 'avg5' }, // محور ۵: 4 شاخص
        { start: 33, end: 40, avgId: 'avg6' }  // محور ۶: 7 شاخص
      ];

      sectionRanges.forEach(range => {
        const sectionScores = scores.slice(range.start, range.end);
        const avg = sectionScores.length > 0
          ? (sectionScores.reduce((a, b) => a + b, 0) / sectionScores.length).toFixed(2)
          : '0.00';
        document.getElementById(range.avgId).textContent = avg;
      });

      const overallAvg = scores.length > 0
        ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2)
        : '0.00';
      document.getElementById('overall_avg').textContent = overallAvg;

      // Update final evaluation based on overall average
      const finalEvalSelect = document.getElementById('final_evaluation');
      const avgValue = parseFloat(overallAvg);
      if (avgValue >= 3.5) finalEvalSelect.value = 'عالی';
      else if (avgValue >= 2.5) finalEvalSelect.value = 'خوب';
      else if (avgValue >= 1.5) finalEvalSelect.value = 'متوسط';
      else finalEvalSelect.value = 'ضعیف';

      generateSmartAnalysis(avgValue);
    }

    /**
     * Generate smart analysis based on average score
     */
    function generateSmartAnalysis(avg) {
      let analysis = [];
      if (avg >= 3.5) {
        analysis = [
          ['تحلیل توانایی', 'آموزگار دارای توانایی‌های برجسته در مدیریت کلاس، تدریس خلاقانه و استفاده بهینه از منابع است.'],
          ['تحلیل هوش', 'سطح هوش هیجانی و عملی بالا، با قابلیت حل مسئله پیچیده در محیط آموزشی.'],
          ['تحلیل روانشناسی', 'شخصیت extroverted و agreeable، با مهارت‌های بالای همدلی و مدیریت استرس.'],
          ['تحلیل عملکرد کلی', 'عملکرد کلی عالی، با نقاط قوت در تمام بخش‌ها.'],
          ['تحلیل نقاط قوت و ضعف', 'قوت: خلاقیت و تعامل بالا. ضعف: ممکن است نیاز به تنوع بیشتر در ابزارهای دیجیتال.'],
          ['پیشنهادات', 'شرکت در کنفرانس‌های آموزشی بین‌المللی و توسعه برنامه‌های مبتنی بر AI.'],
          ['وضعیت پاداش/تشویق', 'شایسته پاداش مالی و ارتقاء شغلی است.']
        ];
      } else if (avg >= 2.5) {
        analysis = [
          ['تحلیل توانایی', 'توانایی‌های خوب در تدریس و مدیریت کلاس، اما نیاز به تقویت در تفاوت‌گذاری فردی.'],
          ['تحلیل هوش', 'هوش متوسط با پتانسیل رشد در حوزه‌های عملی و تحلیلی.'],
          ['تحلیل روانشناسی', 'شخصیت متعادل با تمایل به conscientiousness، نیاز به مدیریت بهتر هیجانات.'],
          ['تحلیل عملکرد کلی', 'عملکرد خوب با پیشرفت در تعامل و ارزشیابی، اما نقاط ضعف در مدیریت زمان.'],
          ['تحلیل نقاط قوت و ضعف', 'قوت: تعامل قوی. ضعف: کمبود تنوع در روش‌های تدریس.'],
          ['پیشنهادات', 'شرکت در دوره‌های روانشناختی آموزشی و کارگاه‌های فناوری.'],
          ['وضعیت پاداش/تشویق', 'شایسته تشویق و حمایت آموزشی است.']
        ];
      } else if (avg >= 1.5) {
        analysis = [
          ['تحلیل توانایی', 'توانایی‌های پایه‌ای در تدریس، اما ضعف در مدیریت کلاس و فناوری.'],
          ['تحلیل هوش', 'هوش عملی متوسط، نیاز به تقویت در حل مسئله و خلاقیت آموزشی.'],
          ['تحلیل روانشناسی', 'ممکن است نشانه‌های استرس یا کمبود اعتمادبه‌نفس وجود داشته باشد.'],
          ['تحلیل عملکرد کلی', 'عملکرد قابل قبول اما ناکافی، نیاز به بهبود در تمام بخش‌ها.'],
          ['تحلیل نقاط قوت و ضعف', 'قوت: تلاش پایه‌ای. ضعف: عدم تنوع در روش‌ها.'],
          ['پیشنهادات', 'برنامه مربیگری فشرده و دوره‌های پایه‌ای روانشناختی و فناوری.'],
          ['وضعیت پاداش/تشویق', 'نیاز به بهبود و حمایت دارد.']
        ];
      } else {
        analysis = [
          ['تحلیل توانایی', 'نیاز به توسعه اساسی در تمام حوزه‌های تدریس و مدیریت.'],
          ['تحلیل هوش', 'پتانسیل هوشی وجود دارد، اما نیازمند آموزش پایه‌ای.'],
          ['تحلیل روانشناسی', 'چالش‌های عاطفی احتمالی مانند خستگی یا کمبود انگیزه.'],
          ['تحلیل عملکرد کلی', 'عملکرد ضعیف، نیاز به بازسازی کامل رویکرد آموزشی.'],
          ['تحلیل نقاط قوت و ضعف', 'قوت: تمایل به تلاش. ضعف: کمبود در تمام بخش‌ها.'],
          ['پیشنهادات', 'برنامه بهبود شخصی‌سازی‌شده و نظارت مستقیم.'],
          ['وضعیت پاداش/تشویق', 'نیاز به تلاش بیشتر و حمایت فوری دارد.']
        ];
      }

      document.getElementById('smart_analysis').innerHTML = analysis.map(row => `
        <tr>
          <td>${row[0]}</td>
          <td>${row[1]}</td>
        </tr>
      `).join('');
    }

    /**
     * Auto-save form on change
     */
    function autoSaveForm() {
      saveForm(true); // true indicates auto-save, no alert
    }

    /**
     * Save form data to localStorage
     * @param {boolean} [auto=false] - If true, no success alert
     */
    function saveForm(auto = false) {
      const personnelCode = document.getElementById('personnel_code').value;
      if (!/^\d{8}$/.test(personnelCode)) {
        if (!auto) {
          Swal.fire({
            icon: 'error',
            title: 'خطا',
            text: 'کد پرسنلی باید ۸ رقم عددی باشد.',
          });
        }
        return;
      }

      const scores = Array.from(document.querySelectorAll('.score:checked')).map(input => input.value);
      if (scores.length !== 40) {  // Total indicators: 9+7+9+4+4+7 = 40
        if (!auto) {
          Swal.fire({
            icon: 'error',
            title: 'خطا',
            text: 'لطفاً تمام امتیازات را انتخاب کنید.',
          });
        }
        return;
      }

      const formData = {
        teacher: document.getElementById('teacher').value,
        personnel_code: personnelCode,
        teacher_phone: document.getElementById('teacher_phone').value,
        grade: document.getElementById('grade').value,
        principal: document.getElementById('principal').value,
        school: document.getElementById('school').value,
        inspector: document.getElementById('inspector').value,
        gender: document.getElementById('gender').value,
        date: document.getElementById('date').value,
        persian_date: document.getElementById('persian_date').value,
        principal_phone: document.getElementById('principal_phone').value,
        school_type: document.getElementById('school_type').value,
        teaching_experience: document.getElementById('teaching_experience').value,
        inspector_signature: document.getElementById('inspector_signature_pad').toDataURL(),
        teacher_signature: document.getElementById('teacher_signature_pad').toDataURL(),
        scores: scores,
        comments: Array.from(document.querySelectorAll('textarea:not(#strengths, #improvements, #suggestions, #teacher_strengths, #teacher_challenges, #teacher_suggestions, #summary, .visitor-analysis)')).map(textarea => textarea.value),
        visitor_analysis: Array.from(document.querySelectorAll('.visitor-analysis')).map(textarea => textarea.value),
        strengths: document.getElementById('strengths').value,
        improvements: document.getElementById('improvements').value,
        suggestions: document.getElementById('suggestions').value,
        teacher_strengths: document.getElementById('teacher_strengths').value,
        teacher_challenges: document.getElementById('teacher_challenges').value,
        teacher_suggestions: document.getElementById('teacher_suggestions').value,
        summary: document.getElementById('summary').value,
        final_evaluation: document.getElementById('final_evaluation').value,
        lastUpdated: moment().locale('fa').format('YYYY/MM/DD HH:mm:ss')
      };

      const requiredFields = ['teacher', 'personnel_code', 'teacher_phone', 'grade', 'principal', 'school', 'inspector', 'gender', 'date', 'principal_phone', 'school_type', 'teaching_experience'];
      const missingFields = requiredFields.filter(id => !document.getElementById(id).value);
      if (missingFields.length > 0) {
        if (!auto) {
          Swal.fire({
            icon: 'error',
            title: 'خطا',
            text: 'لطفاً تمام فیلدهای اجباری را پر کنید.',
          });
        }
        return;
      }

      const key = `inspection_form_red_pink_${formData.teacher}_${formData.date}`;
      localStorage.setItem(key, JSON.stringify(formData));
      loadFormList();
      loadSavedFormsTable();
      if (!auto) {
        Swal.fire({
          icon: 'success',
          title: 'ذخیره شد',
          text: 'فرم با موفقیت ذخیره شد.',
        });
      }
    }

    /**
     * Export all forms to JSON
     */
    function exportToJSON() {
      const allForms = {};
      Object.keys(localStorage)
        .filter(key => key.startsWith('inspection_form_red_pink_'))
        .forEach(key => {
          allForms[key] = JSON.parse(localStorage.getItem(key));
        });

      const jsonContent = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(allForms, null, 2));
      const link = document.createElement('a');
      link.setAttribute('href', jsonContent);
      link.setAttribute('download', 'inspection_forms_red_pink.json');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      Swal.fire({
        icon: 'success',
        title: 'صادر شد',
        text: 'داده‌ها با موفقیت به فایل JSON صادر شدند.',
      });
    }

    /**
     * Import forms from JSON file
     */
    function importFromJSON() {
      document.getElementById('json_import_file').click();
    }

    document.getElementById('json_import_file').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const allForms = JSON.parse(e.target.result);
            Object.keys(allForms).forEach(key => {
              if (key.startsWith('inspection_form_red_pink_')) {
                localStorage.setItem(key, JSON.stringify(allForms[key]));
              }
            });
            loadFormList();
            loadSavedFormsTable();
            Swal.fire({
              icon: 'success',
              title: 'وارد شد',
              text: 'داده‌ها از فایل JSON وارد شدند.',
            });
          } catch (err) {
            Swal.fire({
              icon: 'error',
              title: 'خطا',
              text: 'فایل JSON نامعتبر است.',
            });
          }
        };
        reader.readAsText(file);
      }
    });

    /**
     * Export all forms to CSV
     */
    function exportToCSV() {
      try {
        const forms = Object.keys(localStorage)
          .filter(key => key.startsWith('inspection_form_red_pink_'))
          .map(key => JSON.parse(localStorage.getItem(key)));

        if (forms.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'هشدار',
            text: 'هیچ فرمی برای صادرات وجود ندارد.',
          });
          return;
        }

        const headers = [
          'نام آموزگار', 'کد پرسنلی', 'شماره همراه آموزگار', 'پایه تحصیلی', 'نام مدیر', 'نام مدرسه',
          'نام بازدیدکننده', 'جنسیت', 'تاریخ (میلادی)', 'تاریخ (شمسی)', 'شماره همراه مدیر', 'نوع مدرسه',
          'سابقه تدریس در این پایه', 'امضای بازدیدکننده', 'امضای آموزگار',
          ...Array.from({ length: 9 }, (_, i) => `امتیاز محور 1-${i + 1}`),
          ...Array.from({ length: 9 }, (_, i) => `توضیح محور 1-${i + 1}`),
          ...Array.from({ length: 7 }, (_, i) => `امتیاز محور 2-${i + 1}`),
          ...Array.from({ length: 7 }, (_, i) => `توضیح محور 2-${i + 1}`),
          ...Array.from({ length: 9 }, (_, i) => `امتیاز محور 3-${i + 1}`),
          ...Array.from({ length: 9 }, (_, i) => `توضیح محور 3-${i + 1}`),
          ...Array.from({ length: 4 }, (_, i) => `امتیاز محور 4-${i + 1}`),
          ...Array.from({ length: 4 }, (_, i) => `توضیح محور 4-${i + 1}`),
          ...Array.from({ length: 4 }, (_, i) => `امتیاز محور 5-${i + 1}`),
          ...Array.from({ length: 4 }, (_, i) => `توضیح محور 5-${i + 1}`),
          ...Array.from({ length: 7 }, (_, i) => `امتیاز محور 6-${i + 1}`),
          ...Array.from({ length: 7 }, (_, i) => `توضیح محور 6-${i + 1}`),
          'میانگین محور 1', 'میانگین محور 2', 'میانگین محور 3', 'میانگین محور 4', 'میانگین محور 5', 'میانگین محور 6',
          'نکات قوت', 'نکات قابل بهبود', 'پیشنهادات تخصصی',
          'تحلیل بازدیدکننده - مدیریت کلاس', 'تحلیل بازدیدکننده - روش تدریس', 'تحلیل بازدیدکننده - استفاده از فناوری',
          'تحلیل بازدیدکننده - تعامل با دانش‌آموزان', 'تحلیل بازدیدکننده - ارزشیابی و بازخورد',
          'خودارزیابی - نقاط قوت', 'خودارزیابی - چالش‌ها', 'خودارزیابی - پیشنهادات',
          'جمع‌بندی بازدیدکننده', 'ارزیابی نهایی', 'معدل کل', 'تحلیل توانایی', 'تحلیل هوش', 'تحلیل روانشناسی', 'تحلیل عملکرد کلی', 'تحلیل نقاط قوت و ضعف', 'پیشنهادات', 'وضعیت پاداش/تشویق', 'آخرین بروزرسانی'
        ];

        const data = forms.map(formData => [
          formData.teacher || '-',
          formData.personnel_code || '-',
          formData.teacher_phone || '-',
          formData.grade || '-',
          formData.principal || '-',
          formData.school || '-',
          formData.inspector || '-',
          formData.gender || '-',
          formData.date || '-',
          formData.persian_date || '-',
          formData.principal_phone || '-',
          formData.school_type || '-',
          formData.teaching_experience || '-',
          formData.inspector_signature || '-',
          formData.teacher_signature || '-',
          ...formData.scores.slice(0, 9),
          ...formData.comments.slice(0, 9),
          ...formData.scores.slice(9, 16),
          ...formData.comments.slice(9, 16),
          ...formData.scores.slice(16, 25),
          ...formData.comments.slice(16, 25),
          ...formData.scores.slice(25, 29),
          ...formData.comments.slice(25, 29),
          ...formData.scores.slice(29, 33),
          ...formData.comments.slice(29, 33),
          ...formData.scores.slice(33, 40),
          ...formData.comments.slice(33, 40),
          formData.scores.slice(0, 9).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 9 || 0,
          formData.scores.slice(9, 16).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 7 || 0,
          formData.scores.slice(16, 25).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 9 || 0,
          formData.scores.slice(25, 29).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 4 || 0,
          formData.scores.slice(29, 33).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 4 || 0,
          formData.scores.slice(33, 40).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 7 || 0,
          formData.strengths || '-',
          formData.improvements || '-',
          formData.suggestions || '-',
          ...formData.visitor_analysis,
          formData.teacher_strengths || '-',
          formData.teacher_challenges || '-',
          formData.teacher_suggestions || '-',
          formData.summary || '-',
          formData.final_evaluation || '-',
          formData.scores.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / formData.scores.length || 0,
          formData.analysis_ability || '-',
          formData.analysis_intelligence || '-',
          formData.analysis_psychology || '-',
          formData.analysis_performance || '-',
          formData.analysis_strengths_weaknesses || '-',
          formData.analysis_suggestions || '-',
          formData.analysis_reward || '-',
          formData.lastUpdated || '-'
        ].map(item => `"${item.toString().replace(/"/g, '""')}"`).join(','));

        const csvContent = 'data:text/csv;charset=utf-8,\uFEFF' + [headers.join(','), ...data].join('\n');
        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csvContent));
        link.setAttribute('download', 'inspection_forms_red_pink.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        Swal.fire({
          icon: 'success',
          title: 'صادر شد',
          text: 'داده‌ها با موفقیت به فایل CSV صادر شدند.',
        });
      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'خطا',
          text: 'خطایی در صادرات به CSV رخ داد.',
        });
        console.error('Export to CSV error:', err);
      }
    }

    /**
     * Clear the form
     */
    function clearForm() {
      Swal.fire({
        title: 'آیا مطمئن هستید؟',
        text: 'تمام داده‌های فرم پاک خواهند شد.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'بله، پاک کن',
        cancelButtonText: 'خیر'
      }).then((result) => {
        if (result.isConfirmed) {
          document.querySelectorAll('input:not([type="file"]), textarea, select:not(#final_evaluation)').forEach(element => {
            element.value = '';
          });
          document.querySelectorAll('.score').forEach(input => {
            input.checked = false;
          });
          document.getElementById('final_evaluation').value = 'عالی';
          document.getElementById('persian_date').value = '';
          document.querySelectorAll('.average span').forEach(span => {
            span.textContent = '0';
          });
          clearSignature('inspector_signature_pad');
          clearSignature('teacher_signature_pad');
          document.getElementById('smart_analysis').innerHTML = `
            <tr><td>تحلیل توانایی</td><td>-</td></tr>
            <tr><td>تحلیل هوش</td><td>-</td></tr>
            <tr><td>تحلیل روانشناسی</td><td>-</td></tr>
            <tr><td>تحلیل عملکرد کلی</td><td>-</td></tr>
            <tr><td>تحلیل نقاط قوت و ضعف</td><td>-</td></tr>
            <tr><td>پیشنهادات</td><td>-</td></tr>
            <tr><td>وضعیت پاداش/تشویق</td><td>-</td></tr>
          `;
          updateChart();
          Swal.fire('پاک شد!', 'فرم با موفقیت پاک شد.', 'success');
        }
      });
    }

    /**
     * Clear all saved data
     */
    function clearAllData() {
      Swal.fire({
        title: 'آیا مطمئن هستید؟',
        text: 'تمام داده‌های ذخیره‌شده حذف خواهند شد.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'بله، حذف کن',
        cancelButtonText: 'خیر'
      }).then((result) => {
        if (result.isConfirmed) {
          Object.keys(localStorage)
            .filter(key => key.startsWith('inspection_form_red_pink_'))
            .forEach(key => localStorage.removeItem(key));
          loadFormList();
          loadSavedFormsTable();
          Swal.fire('حذف شد!', 'تمام داده‌ها با موفقیت حذف شدند.', 'success');
        }
      });
    }
  </script>
</body>
</html>
